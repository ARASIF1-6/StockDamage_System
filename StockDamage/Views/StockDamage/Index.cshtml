@{
    ViewBag.Title = "Stock Damage";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container-fluid mt-3">
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">Stock Damage</h4>
        </div>
        <div class="card-body">

            <!-- Form Inputs -->
            <div class="row">

                <div class="col-md-6">
                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Date</label>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="date" class="form-control" id="date" value="2025-06-09" />
                                <button class="btn btn-outline-secondary" type="button">📅</button>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Voucher No</label>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="voucherNo" placeholder="Auto generated Voucher Number" readonly />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Warehouse Name</label>
                        <div class="col-md-8">
                            <select id="warehouse" class="form-select">
                                @foreach (System.Data.DataRow row in ViewBag.Godown.Rows)
                                {
                                    <option value="@row["GodownNo"]">@row["GodownName"]</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Item Name</label>
                        <div class="col-md-8">
                            <select id="item" class="form-select">
                                @foreach (System.Data.DataRow row in ViewBag.Items.Rows)
                                {
                                    <option value="@row["SubItemCode"]">@row["SubItemName"]</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Item Code</label>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="itemCode" readonly />
                        </div>

                        <label class="col-md-1 col-form-label">Unit</label>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="unit" readonly />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Batch No</label>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="batchNo" readonly value="NA" />
                        </div>

                        <label class="col-md-1 col-form-label">Stock</label>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="stock" readonly />
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Currency</label>
                        <div class="col-md-9">
                            <select id="currency" class="form-select">
                                @foreach (System.Data.DataRow row in ViewBag.Currency.Rows)
                                {
                                    <option>@row["CurrencyName"]</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Quantity</label>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="qty" min="0" step="any" />
                        </div>

                        <label class="col-md-2 col-form-label">Rate</label>
                        <div class="col-md-4">
                            <input type="number" class="form-control" id="rate" min="0" step="any" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Amount in</label>
                        <div class="col-md-9">
                            <input type="text" class="form-control" id="amountBdt" />
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Exchange Rate(in BDT)</label>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="exchangeRate" readonly step="any" />
                        </div>

                        <label class="col-md-2 col-form-label">Total Amount</label>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="totalAmount" readonly value="0.00" />
                        </div>

                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Dr A/C Head</label>
                        <div class="col-md-9">
                            <select class="form-select" id="drHead">
                                <option>Stock Damage</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Employee Name</label>
                        <div class="col-md-9">
                            <select id="employee" class="form-select">
                                @foreach (System.Data.DataRow row in ViewBag.Employee.Rows)
                                {
                                    <option>@row["EmployeeName"]</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-2">
                        <label class="col-md-3 col-form-label">Comments</label>
                        <div class="col-md-9">
                            <textarea class="form-control" id="comments" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="col-md-1">
                    <button id="add" class="btn btn-secondary">+ Add</button>
                </div>

            </div>

            <!-- Table -->
            <div class="mt-4">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="tempTable">
                        <thead>
                            <tr>
                                <th>SL#</th>
                                <th>Warehouse Name</th>
                                <th>Item Name</th>
                                <th>Item Code</th>
                                <th>Batch No</th>
                                <th>Currency</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Amount (in BDT)</th>
                                <th>Exchange Rate (in BDT)</th>
                                <th>Total Amount</th>
                                <th>Edit</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- rows added via JS -->
                        </tbody>
                    </table>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Total Amount: </strong>
                        <span id="grandTotal">0.00</span> BDT
                    </div>
                </div>

                <div class="mt-4">
                    <button id="save" class="btn btn-secondary px-5">Save</button>
                </div>

            </div>

        </div>
    </div>
</div>

<script>
    var list = [];
    var slCounter = 1;

    $("#add").click(function () {
        let qty = parseFloat($("#qty").val()) || 0;
        let rate = parseFloat($("#rate").val()) || 0;
        let exRate = parseFloat($("#exchangeRate").val()) || 1;
        let SL = slCounter++;

        var obj = {
            WarehouseName: $("#warehouse option:selected").text(),
            SubItemName: $("#item option:selected").text(),
            SubItemCode: $("#itemCode").val() || $("#item").val(),
            BatchNo: $("#batchNo").val(),
            Currency: $("#currency").val(),
            Quantity: qty,
            Rate: rate,
            AmountIn: $("#amountBdt").val(),
            ExchangeRate: exRate,
            TotalAmount: $("#totalAmount").val(),
            EmployeeName: $("#employee").val(),
            Comments: $("#comments").val()
        };

        list.push(obj);

        $("#tempTable tbody").append(`
            <tr>
                <td>${SL}</td>
                <td>${obj.WarehouseName}</td>
                <td>${obj.SubItemName}</td>
                <td>${obj.SubItemCode}</td>
                <td>${obj.BatchNo || ''}</td>
                <td>${obj.Currency}</td>
                <td>${obj.Quantity}</td>
                <td>${obj.Rate}</td>
                <td>${obj.AmountIn}</td>
                <td>${obj.ExchangeRate}</td>
                <td>${obj.TotalAmount}</td>
                <td><button class="btn btn-sm btn-warning edit-row">Edit</button></td>
                <td><button class="btn btn-sm btn-danger delete-row">Delete</button></td>
            </tr>
        `);

        updateGrandTotal();

        // clear inputs
        $("#qty, #rate, #comments").val("");
    });

    // Delete row
    $(document).on("click", ".delete-row", function () {
        let row = $(this).closest("tr");
        let index = row.index();
        list.splice(index, 1);
        row.remove();
        updateGrandTotal();
    });

    function updateGrandTotal() {
        let sum = list.reduce((acc, item) => acc + parseFloat(item.TotalAmount || 0), 0);
        $("#grandTotal").text(sum.toFixed(2));
    }

    $('#item').change(function () {
        var subItemCode = $(this).val();

        if (subItemCode !== "") {
            $.ajax({
                url: '/StockDamage/GetItemDetails',
                type: 'GET',
                data: { subItemCode: subItemCode },
                success: function (data) {
                    if (data) {
                        $('#itemCode').val(data.SubItemCode);
                        $('#unit').val(data.Unit);
                        $('#stock').val(data.StockQty);
                    }
                }
            });
        } else {
            $('#itemCode').val('');
            $('#unit').val('');
            $('#stock').val('');
        }
    });

    $('#currency').change(function () {

        var currencyName = $(this).val();

        if (currencyName !== "") {
            $.ajax({
                url: '/StockDamage/GetExchangeRate',
                type: 'GET',
                data: { currencyName: currencyName },
                success: function (data) {
                    if (data) {
                        $('#exchangeRate').val(data.Rate);
                    }
                }
            });
        } else {
            $('#exchangeRate').val('');
        }
    });

    $('#amountBdt').on('input', function () {

        var amount = parseFloat($(this).val());

        if (!isNaN(amount)) {
            $('#totalAmount').val(amount.toFixed(2));
        } else {
            $('#totalAmount').val('0.00');
        }
    });

    $("#save").click(function () {
        if (list.length === 0) {
            alert("No items to save.");
            return;
        }

        $.ajax({
            url: '/StockDamage/Save',
            type: 'POST',
            data: JSON.stringify(list),
            contentType: 'application/json',
            success: function (res) {
                alert(res.message || "Saved successfully!");
                location.reload();
            },
            error: function () {
                alert("Error while saving.");
            }
        });
    });
</script>